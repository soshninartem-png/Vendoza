{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ì–ª–∞–≤–Ω–∞—è</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Inter', sans-serif;
    background: #f4f4f4;
    min-height: 100vh;
    padding: 40px 20px;
  }

  /* ‚ïê‚ïê NAV BUTTONS ‚ïê‚ïê */
  .nav-buttons {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .nav-btn {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    background: #ffffff;
    border: 1.5px solid #e0e0e0;
    border-radius: 12px;
    padding: 14px 22px;
    font-family: 'Inter', sans-serif;
    font-size: 15px;
    font-weight: 600;
    color: #111111;
    cursor: pointer;
    text-decoration: none;
    box-shadow: 0 1px 4px rgba(0,0,0,0.07);
    transition: box-shadow 0.2s, transform 0.15s, border-color 0.2s, background 0.2s;
    white-space: nowrap;
  }
  .nav-btn:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.10); transform: translateY(-1px); border-color: #bdbdbd; background: #fafafa; }
  .nav-btn:active { transform: translateY(0); }

  /* ‚ïê‚ïê OVERLAY ‚ïê‚ïê */
  #sp-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.45);
    backdrop-filter: blur(2px);
    z-index: 500;
    opacity: 0;
    transition: opacity 0.35s ease;
  }

  /* ‚ïê‚ïê SETTINGS PANEL ‚ïê‚ïê */
  #sp-panel {
    position: fixed;
    top: 0; left: 0;
    width: min(400px, 95vw);
    height: 100vh;
    background: #ffffff;
    z-index: 600;
    transform: translateX(-100%);
    transition: transform 0.42s cubic-bezier(0.16, 1, 0.3, 1);
    display: flex;
    flex-direction: column;
    box-shadow: 6px 0 32px rgba(0,0,0,0.13);
    border-right: 1px solid #e8e8e8;
    font-family: 'Inter', sans-serif;
  }
  #sp-panel.open { transform: translateX(0); }

  .sp-header {
    padding: 24px 24px 20px;
    border-bottom: 1px solid #eeeeee;
    display: flex; align-items: center; justify-content: space-between;
    flex-shrink: 0;
    background: #fafafa;
  }
  .sp-header-left { display: flex; align-items: center; gap: 12px; }
  .sp-icon-wrap {
    width: 38px; height: 38px; border-radius: 10px;
    background: #111;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }
  .sp-title { font-size: 16px; font-weight: 700; color: #111; letter-spacing: -0.3px; }
  .sp-subtitle { font-size: 11px; color: #999; margin-top: 2px; }

  #sp-close {
    width: 32px; height: 32px; border-radius: 8px;
    border: 1.5px solid #e0e0e0;
    background: #fff; color: #999; font-size: 16px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.2s, color 0.2s;
    line-height: 1;
  }
  #sp-close:hover { background: #f0f0f0; color: #111; }

  .sp-body {
    flex: 1; overflow-y: auto;
    padding: 20px 24px;
    scrollbar-width: thin; scrollbar-color: #ddd transparent;
  }

  .sp-section { margin-bottom: 24px; }
  .sp-section-title {
    font-size: 10px; font-weight: 700;
    letter-spacing: 1.5px; text-transform: uppercase;
    color: #aaa; margin-bottom: 4px;
    padding-bottom: 8px; border-bottom: 1px solid #f0f0f0;
  }

  .sp-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid #f5f5f5;
    gap: 12px;
    opacity: 0; transform: translateX(-14px);
    transition: opacity 0.32s, transform 0.32s;
  }
  .sp-row:last-child { border-bottom: none; }
  #sp-panel.open .sp-row { opacity: 1; transform: translateX(0); }
  #sp-panel.open .sp-row:nth-child(1) { transition-delay: 0.08s; }
  #sp-panel.open .sp-row:nth-child(2) { transition-delay: 0.13s; }
  #sp-panel.open .sp-row:nth-child(3) { transition-delay: 0.18s; }
  #sp-panel.open .sp-row:nth-child(4) { transition-delay: 0.23s; }

  .sp-row-info { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; }
  .sp-row-icon {
    width: 32px; height: 32px; border-radius: 8px;
    background: #f5f5f5;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; font-size: 15px;
  }
  .sp-row-text h4 { font-size: 13px; font-weight: 600; color: #111; }
  .sp-row-text p  { font-size: 11px; color: #999; margin-top: 1px; }

  /* Toggle */
  .sp-toggle { position: relative; flex-shrink: 0; cursor: pointer; display: flex; align-items: center; }
  .sp-toggle input { display: none; }
  .sp-toggle-track {
    display: block; width: 44px; height: 24px;
    background: #d5d5d5; border-radius: 12px;
    position: relative; transition: background 0.25s;
  }
  .sp-toggle-track::after {
    content: ''; position: absolute;
    width: 18px; height: 18px; top: 3px; left: 3px;
    background: #fff; border-radius: 50%;
    box-shadow: 0 1px 3px rgba(0,0,0,0.25);
    transition: transform 0.25s cubic-bezier(0.34,1.56,0.64,1);
  }
  .sp-toggle input:checked + .sp-toggle-track { background: #111; }
  .sp-toggle input:checked + .sp-toggle-track::after { transform: translateX(20px); }

  /* Select */
  .sp-select {
    background: #f5f5f5; border: 1.5px solid #e0e0e0;
    color: #111; font-family: 'Inter', sans-serif;
    font-size: 12px; font-weight: 500;
    padding: 7px 26px 7px 10px; border-radius: 8px;
    outline: none; cursor: pointer;
    appearance: none; -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23999' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 8px center;
    transition: border-color 0.2s; flex-shrink: 0;
  }
  .sp-select:focus { border-color: #111; }

  /* Edit btn */
  .sp-edit-btn {
    font-size: 12px; font-weight: 500;
    color: #555; background: #f0f0f0;
    border: 1.5px solid #e0e0e0; border-radius: 8px;
    padding: 6px 12px; cursor: pointer;
    white-space: nowrap; flex-shrink: 0;
    transition: background 0.2s, color 0.2s;
    font-family: 'Inter', sans-serif;
  }
  .sp-edit-btn:hover { background: #e5e5e5; color: #111; }

  /* Footer */
  .sp-footer {
    padding: 16px 24px 24px;
    border-top: 1px solid #eee;
    flex-shrink: 0;
  }
  .sp-close-btn {
    width: 100%; padding: 12px; border-radius: 10px;
    background: #f5f5f5; border: 1.5px solid #e0e0e0;
    color: #777; font-size: 13px; font-weight: 600;
    cursor: pointer; font-family: 'Inter', sans-serif;
    transition: background 0.2s, color 0.2s;
  }
  .sp-close-btn:hover { background: #ebebeb; color: #333; }

  /* ‚ïê‚ïê MODAL BACKDROP ‚ïê‚ïê */
  #sp-modal-backdrop {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.4);
    backdrop-filter: blur(2px);
    z-index: 700;
    opacity: 0;
    transition: opacity 0.25s;
  }

  /* ‚ïê‚ïê MODAL BOX ‚ïê‚ïê */
  .sp-modal {
    display: none;
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -48%) scale(0.96);
    z-index: 800;
    background: #fff;
    border-radius: 16px;
    padding: 28px;
    width: min(360px, 90vw);
    box-shadow: 0 8px 40px rgba(0,0,0,0.16);
    opacity: 0;
    transition: opacity 0.25s, transform 0.25s;
    font-family: 'Inter', sans-serif;
  }
  .sp-modal.show {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }
  .sp-modal h3 { font-size: 15px; font-weight: 700; color: #111; margin-bottom: 16px; }
  .sp-modal label {
    font-size: 12px; font-weight: 600; color: #666;
    display: block; margin-bottom: 5px; margin-top: 12px;
  }
  .sp-modal label:first-of-type { margin-top: 0; }
  .sp-modal-input {
    width: 100%; padding: 10px 12px;
    border: 1.5px solid #e0e0e0; border-radius: 9px;
    font-size: 13px; font-family: 'Inter', sans-serif;
    outline: none; color: #111;
    transition: border-color 0.2s;
  }
  .sp-modal-input:focus { border-color: #111; }
  .sp-modal-footer { display: flex; gap: 8px; margin-top: 20px; }
  .sp-modal-cancel {
    flex: 1; padding: 10px; border-radius: 9px;
    border: 1.5px solid #e0e0e0; background: #f5f5f5;
    color: #777; font-size: 13px; font-weight: 600;
    cursor: pointer; font-family: 'Inter', sans-serif;
    transition: background 0.2s;
  }
  .sp-modal-cancel:hover { background: #eee; color: #333; }
  .sp-modal-save {
    flex: 1; padding: 10px; border-radius: 9px;
    border: none; background: #111; color: #fff;
    font-size: 13px; font-weight: 600;
    cursor: pointer; font-family: 'Inter', sans-serif;
    transition: background 0.2s;
  }
  .sp-modal-save:hover { background: #333; }

  /* ‚ïê‚ïê TOAST ‚ïê‚ïê */
  #sp-toast {
    position: fixed; bottom: 28px; left: 50%;
    transform: translateX(-50%) translateY(70px);
    background: #111; color: #fff;
    padding: 11px 20px; border-radius: 10px;
    font-size: 13px; font-weight: 500;
    z-index: 1000; opacity: 0;
    transition: transform 0.35s cubic-bezier(0.16,1,0.3,1), opacity 0.35s;
    pointer-events: none; white-space: nowrap;
    font-family: 'Inter', sans-serif;
  }
  #sp-toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }
</style>
</head>
<body>




  <!-- Header -->
  <div class="sp-header">
    <div class="sp-header-left">
      <div class="sp-icon-wrap">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"/>
          <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/>
        </svg>
      </div>
      <div>
        <div class="sp-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div class="sp-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–º</div>
      </div>
    </div>
    <button id="sp-close" onclick="spClose()">‚úï</button>
  </div>

  <!-- Body -->
  <div class="sp-body">

    <!-- –ü–†–û–§–ò–õ–¨ -->
    <div class="sp-section">
      <div class="sp-section-title">–ü—Ä–æ—Ñ–∏–ª—å</div>

      <div class="sp-row">
        <div class="sp-row-info">
          <div class="sp-row-icon">üë§</div>
          <div class="sp-row-text">
            <h4>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h4>
            <p id="sp-disp-username">{{ user.username|default:"user_1234" }}</p>
          </div>
        </div>
        <button class="sp-edit-btn" onclick="spOpenModal('username')">–ò–∑–º–µ–Ω–∏—Ç—å</button>
      </div>

      <div class="sp-row">
        <div class="sp-row-info">
          <div class="sp-row-icon">üìß</div>
          <div class="sp-row-text">
            <h4>Email</h4>
            <p id="sp-disp-email">{{ user.email|default:"user@example.com" }}</p>
          </div>
        </div>
        <button class="sp-edit-btn" onclick="spOpenModal('email')">–ò–∑–º–µ–Ω–∏—Ç—å</button>
      </div>

      <div class="sp-row">
        <div class="sp-row-info">
          <div class="sp-row-icon">üîí</div>
          <div class="sp-row-text">
            <h4>–ü–∞—Ä–æ–ª—å</h4>
            <p>–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å</p>
          </div>
        </div>
        <button class="sp-edit-btn" onclick="spOpenModal('password')">–°–º–µ–Ω–∏—Ç—å</button>
      </div>
    </div>

    <!-- –ò–ù–¢–ï–†–§–ï–ô–° -->
    <div class="sp-section">
      <div class="sp-section-title">–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</div>

      <div class="sp-row">
        <div class="sp-row-info">
          <div class="sp-row-icon">üåç</div>
          <div class="sp-row-text">
            <h4>–Ø–∑—ã–∫</h4>
            <p>–í—ã–±–æ—Ä —è–∑—ã–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</p>
          </div>
        </div>
        <select class="sp-select" id="sp-lang"
          onchange="spSaveSetting('language', this.value)">
          <option value="ru" {% if settings.language == 'ru' or not settings.language %}selected{% endif %}>–†—É—Å—Å–∫–∏–π</option>
          <option value="en" {% if settings.language == 'en' %}selected{% endif %}>English</option>
          <option value="uz" {% if settings.language == 'uz' %}selected{% endif %}>O'zbek</option>
        </select>
      </div>

      <div class="sp-row">
        <div class="sp-row-info">
          <div class="sp-row-icon">üåô</div>
          <div class="sp-row-text">
            <h4>–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</h4>
            <p>–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</p>
          </div>
        </div>
        <label class="sp-toggle">
          <input type="checkbox" id="sp-dark-mode"
            {% if settings.dark_mode %}checked{% endif %}
            onchange="spSaveSetting('dark_mode', this.checked)">
          <span class="sp-toggle-track"></span>
        </label>
      </div>
    </div>

    <!-- –ü–†–ò–í–ê–¢–ù–û–°–¢–¨ -->
    <div class="sp-section">
      <div class="sp-section-title">–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</div>

      <div class="sp-row">
        <div class="sp-row-info">
          <div class="sp-row-icon">üìä</div>
          <div class="sp-row-text">
            <h4>–°–±–æ—Ä –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</h4>
            <p>–£–ª—É—á—à–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞</p>
          </div>
        </div>
        <label class="sp-toggle">
          <input type="checkbox" id="sp-analytics"
            {% if settings.analytics %}checked{% endif %}
            onchange="spSaveSetting('analytics', this.checked)">
          <span class="sp-toggle-track"></span>
        </label>
      </div>

      <div class="sp-row">
        <div class="sp-row-info">
          <div class="sp-row-icon">üõ°Ô∏è</div>
          <div class="sp-row-text">
            <h4>–î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ.</h4>
            <p>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞</p>
          </div>
        </div>
        <label class="sp-toggle">
          <input type="checkbox" id="sp-twofa"
            {% if settings.twofa %}checked{% endif %}
            onchange="spSaveSetting('twofa', this.checked)">
          <span class="sp-toggle-track"></span>
        </label>
      </div>
    </div>

  </div><!-- /sp-body -->

  <div class="sp-footer">
    <button class="sp-close-btn" onclick="spClose()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL BACKDROP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="sp-modal-backdrop" onclick="spCloseModal()"></div>

<!-- Modal: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
<div class="sp-modal" id="sp-modal-username">
  <h3>–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
  <label>–ù–æ–≤–æ–µ –∏–º—è</label>
  <input class="sp-modal-input" type="text" id="sp-inp-username"
    placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è" value="{{ user.username }}">
  <div class="sp-modal-footer">
    <button class="sp-modal-cancel" onclick="spCloseModal()">–û—Ç–º–µ–Ω–∞</button>
    <button class="sp-modal-save" onclick="spSaveUsername()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>

<!-- Modal: Email -->
<div class="sp-modal" id="sp-modal-email">
  <h3>–ò–∑–º–µ–Ω–∏—Ç—å Email</h3>
  <label>–ù–æ–≤—ã–π Email</label>
  <input class="sp-modal-input" type="email" id="sp-inp-email"
    placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π email" value="{{ user.email }}">
  <div class="sp-modal-footer">
    <button class="sp-modal-cancel" onclick="spCloseModal()">–û—Ç–º–µ–Ω–∞</button>
    <button class="sp-modal-save" onclick="spSaveEmail()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>

<!-- Modal: –ü–∞—Ä–æ–ª—å -->
<div class="sp-modal" id="sp-modal-password">
  <h3>–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</h3>
  <label>–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
  <input class="sp-modal-input" type="password" id="sp-inp-old-pw" placeholder="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å">
  <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
  <input class="sp-modal-input" type="password" id="sp-inp-new-pw" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
  <label>–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
  <input class="sp-modal-input" type="password" id="sp-inp-conf-pw" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
  <div class="sp-modal-footer">
    <button class="sp-modal-cancel" onclick="spCloseModal()">–û—Ç–º–µ–Ω–∞</button>
    <button class="sp-modal-save" onclick="spSavePassword()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>

<!-- Toast -->
<div id="sp-toast"></div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     JAVASCRIPT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
const spPanel   = document.getElementById('sp-panel');
const spOverlay = document.getElementById('sp-overlay');

// ‚îÄ‚îÄ OPEN / CLOSE PANEL ‚îÄ‚îÄ
function spOpen() {
  spOverlay.style.display = 'block';
  document.body.style.overflow = 'hidden';
  setTimeout(() => {
    spPanel.classList.add('open');
    spOverlay.style.opacity = '1';
  }, 10);
}

function spClose() {
  spPanel.classList.remove('open');
  spOverlay.style.opacity = '0';
  document.body.style.overflow = '';
  setTimeout(() => { spOverlay.style.display = 'none'; }, 360);
  spCloseModal();
}

// ‚îÄ‚îÄ KEYBOARD ‚îÄ‚îÄ
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { spCloseModal(); spClose(); }
});

// ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ
function spOpenModal(type) {
  spCloseModal();
  const backdrop = document.getElementById('sp-modal-backdrop');
  const box = document.getElementById('sp-modal-' + type);
  backdrop.style.display = 'block';
  box.style.display = 'block';
  setTimeout(() => {
    backdrop.style.opacity = '1';
    box.classList.add('show');
    const inp = box.querySelector('.sp-modal-input');
    if (inp) inp.focus();
  }, 10);
}

function spCloseModal() {
  const backdrop = document.getElementById('sp-modal-backdrop');
  backdrop.style.opacity = '0';
  document.querySelectorAll('.sp-modal').forEach(m => {
    m.classList.remove('show');
    setTimeout(() => { m.style.display = 'none'; }, 260);
  });
  setTimeout(() => { backdrop.style.display = 'none'; }, 260);
}

// ‚îÄ‚îÄ SAVE USERNAME ‚îÄ‚îÄ
function spSaveUsername() {
  const val = document.getElementById('sp-inp-username').value.trim();
  if (!val) { spToast('‚ùå –í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'); return; }
  fetch("{% url 'shop:settings-save' %}", {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': spCsrf() },
    body: JSON.stringify({ username: val })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      document.getElementById('sp-disp-username').textContent = val;
      spCloseModal();
      spToast('‚úÖ –ò–º—è –∏–∑–º–µ–Ω–µ–Ω–æ');
    } else {
      spToast('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞'));
    }
  })
  .catch(() => spToast('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏'));
}

// ‚îÄ‚îÄ SAVE EMAIL ‚îÄ‚îÄ
function spSaveEmail() {
  const val = document.getElementById('sp-inp-email').value.trim();
  if (!val || !val.includes('@')) { spToast('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email'); return; }
  fetch("{% url 'shop:settings-save' %}", {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': spCsrf() },
    body: JSON.stringify({ email: val })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      document.getElementById('sp-disp-email').textContent = val;
      spCloseModal();
      spToast('‚úÖ Email –∏–∑–º–µ–Ω—ë–Ω');
    } else {
      spToast('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞'));
    }
  })
  .catch(() => spToast('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏'));
}

// ‚îÄ‚îÄ SAVE PASSWORD ‚îÄ‚îÄ
function spSavePassword() {
  const oldPw  = document.getElementById('sp-inp-old-pw').value;
  const newPw  = document.getElementById('sp-inp-new-pw').value;
  const confPw = document.getElementById('sp-inp-conf-pw').value;
  if (!oldPw || !newPw || !confPw) { spToast('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'); return; }
  if (newPw !== confPw)            { spToast('‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç'); return; }
  if (newPw.length < 6)           { spToast('‚ùå –ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤'); return; }
  fetch("{% url 'shop:settings-save' %}", {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': spCsrf() },
    body: JSON.stringify({ old_password: oldPw, new_password: newPw })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      spCloseModal();
      spToast('‚úÖ –ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω');
      ['sp-inp-old-pw','sp-inp-new-pw','sp-inp-conf-pw']
        .forEach(id => document.getElementById(id).value = '');
    } else {
      spToast('‚ùå ' + (data.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å'));
    }
  })
  .catch(() => spToast('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏'));
}

// ‚îÄ‚îÄ SAVE SETTING (toggle / select) ‚îÄ‚îÄ
function spSaveSetting(key, value) {
  fetch("{% url 'shop:settings-save' %}", {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': spCsrf() },
    body: JSON.stringify({ [key]: value })
  })
  .then(r => r.json())
  .then(data => { if (data.success) spToast('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); })
  .catch(() => {});
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
let spToastTimer;
function spToast(msg) {
  const el = document.getElementById('sp-toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(spToastTimer);
  spToastTimer = setTimeout(() => el.classList.remove('show'), 3000);
}

// ‚îÄ‚îÄ CSRF ‚îÄ‚îÄ
function spCsrf() {
  return document.cookie.split(';').reduce((v, c) => {
    const [k, val] = c.trim().split('=');
    return k === 'csrftoken' ? decodeURIComponent(val) : v;
  }, '');
}
</script>

</body>
</html>